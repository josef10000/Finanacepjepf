<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Hub Symples</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230f172a'/><text x='50' y='70' fill='%233b82f6' font-size='50' text-anchor='middle' font-weight='bold'>HS</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        input, select, textarea { color-scheme: dark; }
        .page { transition: opacity 0.2s ease-in-out; }
        .hidden { display: none !important; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #94a3b8; transition: all 0.2s ease; border-left: 3px solid transparent; cursor: pointer; }
        .nav-link:hover { background: linear-gradient(90deg, rgba(37,99,235,0.15) 0%, rgba(37,99,235,0) 100%); color: #60a5fa; border-left-color: #3b82f6; padding-left: 1.25rem; }
        .nav-link.active { background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); border-left-color: transparent; }
        .card-glow { transition: box-shadow 0.3s ease; }
        .card-glow:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.15); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #334155; }
        .calendar-day { min-height: 100px; background-color: #1e293b; padding: 0.5rem; display: flex; flex-direction: column; position: relative; }
        .calendar-day:hover { background-color: #252f42; }
        .calendar-header { text-align: center; padding: 0.5rem; font-weight: bold; color: #94a3b8; background-color: #0f172a; }
        .checklist-item.checked span { text-decoration: line-through; color: #64748b; }
        
        /* Heatmap Intensities */
        .heat-low { background-color: rgba(59, 130, 246, 0.1) !important; }
        .heat-med { background-color: rgba(59, 130, 246, 0.25) !important; }
        .heat-high { background-color: rgba(59, 130, 246, 0.4) !important; }
        
        /* Tema PF */
        body.theme-pf .nav-link.active { background: linear-gradient(90deg, #7c3aed 0%, #6d28d9 100%); border-left-color: transparent; }
        body.theme-pf .nav-link:hover { color: #a78bfa; border-left-color: #8b5cf6; }
        body.theme-pf h1 { background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; color: transparent; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="h-full bg-slate-900 text-slate-200 font-sans antialiased theme-pj">

    <div class="flex h-full">
        <!-- SIDEBAR -->
        <nav class="flex flex-col w-64 bg-slate-800 shadow-2xl h-full flex-shrink-0 border-r border-slate-700/50 z-20">
            <div class="p-6 text-center border-b border-slate-700/50 relative">
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-green-400 bg-clip-text text-transparent mb-4 cursor-pointer" onclick="location.reload()">Financeiro Hub</h1>
                
                <!-- PROFILE TOGGLE -->
                <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-700 mb-2">
                    <button onclick="switchProfile('PJ')" id="btn-prof-pj" class="flex-1 py-2 text-xs font-bold rounded text-white bg-blue-600 shadow transition-all">Empresa (PJ)</button>
                    <button onclick="switchProfile('PF')" id="btn-prof-pf" class="flex-1 py-2 text-xs font-bold rounded text-slate-400 hover:text-white transition-all">Pessoal (PF)</button>
                </div>
                <button onclick="showHoldingReport()" class="text-[10px] text-blue-400 hover:text-blue-300 w-full text-center mt-1">Ver Relatório Holding</button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar py-4">
                <ul class="flex flex-col px-3 space-y-1" id="nav-list">
                    <!-- Menu Dinâmico via JS -->
                </ul>
            </div>
            <div class="p-4 text-center text-xs text-slate-600 border-t border-slate-700/50">v14.6.0 (Stable)</div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="flex-1 h-full overflow-y-auto p-4 md:p-8 relative bg-slate-900">
            <div class="max-w-7xl mx-auto pb-24">
                
                <div id="notification-center" class="mb-6 hidden">
                    <div class="bg-slate-800/80 backdrop-blur border border-slate-700 rounded-lg p-4 flex items-start gap-3 shadow-lg">
                        <div class="bg-red-500/20 p-2 rounded text-red-400"><ion-icon name="notifications"></ion-icon></div>
                        <div class="flex-1"><h4 class="font-bold text-white">Atenção</h4><ul id="notification-list" class="text-sm text-slate-300 mt-1 list-disc list-inside"></ul></div>
                        <button id="btn-close-notif" class="text-slate-500 hover:text-white"><ion-icon name="close"></ion-icon></button>
                    </div>
                </div>

                <button id="open-modal-btn" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center z-40 transition-all hover:scale-110 active:scale-95"><ion-icon name="add-outline" class="text-4xl"></ion-icon></button>

                <!-- DASHBOARD -->
                <section id="page-dashboard" class="page">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-white tracking-tight" id="dash-title">Dashboard</h2>
                        <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                            <button class="px-3 py-1 text-sm rounded hover:bg-slate-700 text-slate-300" id="btn-filter-thisMonth">Este Mês</button>
                            <button class="px-3 py-1 text-sm rounded hover:bg-slate-700 text-slate-300" id="btn-filter-lastMonth">Mês Passado</button>
                            <button class="px-3 py-1 text-sm rounded hover:bg-slate-700 text-slate-300" id="btn-filter-all">Tudo</button>
                        </div>
                    </div>
                    
                    <!-- KPI CARDS (3 COLUMNS NOW) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 relative overflow-hidden card-glow">
                            <h3 class="text-sm font-medium text-blue-400 uppercase tracking-wider">Saldo Real (Hoje)</h3>
                            <p id="dashboard-saldo-consolidado" class="text-3xl font-bold text-white mt-2">R$ 0,00</p>
                            <p class="text-xs text-slate-500 mt-1">Disponível para uso imediato</p>
                        </div>
                        
                        <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 relative card-glow">
                            <h3 class="text-sm font-medium text-green-400 uppercase tracking-wider">Receitas</h3>
                            <p id="dashboard-receita" class="text-3xl font-bold text-white mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 relative card-glow">
                            <h3 class="text-sm font-medium text-red-400 uppercase tracking-wider">Despesas</h3>
                            <p id="dashboard-despesa" class="text-3xl font-bold text-white mt-2">R$ 0,00</p>
                        </div>
                    </div>

                    <!-- RUNWAY (PJ) or FIRE (PF) -->
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <!-- Runway (PJ) -->
                        <div id="widget-runway" class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 relative overflow-hidden">
                            <div class="absolute right-0 top-0 p-4 opacity-10"><ion-icon name="pulse" class="text-6xl text-red-500"></ion-icon></div>
                            <h3 class="text-sm font-medium text-red-400 uppercase tracking-wider" id="runway-title">Runway (Crise)</h3>
                            <p id="dashboard-stress-test" class="text-3xl font-bold text-white mt-2">-- meses</p>
                            <p class="text-xs text-slate-500 mt-1" id="stress-detail">Sobrevivência sem receitas</p>
                        </div>

                        <!-- 50/30/20 Widget (PF Only) -->
                        <div id="widget-503020" class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 relative hidden">
                            <h3 class="text-sm font-medium text-indigo-400 uppercase tracking-wider">Estilo de Vida (50/30/20)</h3>
                            <div class="flex items-center gap-4 mt-2">
                                <div class="w-16 h-16"><canvas id="chart-503020"></canvas></div>
                                <div class="flex-1 space-y-1 text-xs">
                                    <div class="flex justify-between"><span class="text-blue-300">Essencial (50%)</span><span class="text-white font-bold" id="val-essencial">0%</span></div>
                                    <div class="flex justify-between"><span class="text-purple-300">Estilo (30%)</span><span class="text-white font-bold" id="val-estilo">0%</span></div>
                                    <div class="flex justify-between"><span class="text-green-300">Objetivos (20%)</span><span class="text-white font-bold" id="val-objetivos">0%</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Tax Provision (PJ Only) -->
                        <div id="widget-tax" class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg flex flex-col justify-between relative overflow-hidden gap-4">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-amber-500"></div>
                            <div class="flex items-center gap-4 pl-2"><div class="bg-amber-500/20 p-3 rounded-full text-amber-400"><ion-icon name="shield-checkmark" class="text-2xl"></ion-icon></div><div><h4 class="text-white font-bold">Provisão de Impostos</h4><p class="text-sm text-slate-400">Restante: <span id="dashboard-tax-provision" class="font-bold text-amber-400">R$ 0,00</span></p></div></div>
                            <button id="btn-tax-action" onclick="openTaxOptions()" class="w-full bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded font-bold shadow-lg">Gerenciar</button>
                        </div>

                        <!-- War Chest (PJ Only) -->
                        <div id="widget-war" class="bg-slate-800/50 border border-slate-700 p-4 rounded-lg flex flex-col justify-between relative overflow-hidden gap-4">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-purple-500"></div>
                            <div class="flex items-center gap-4 pl-2"><div class="bg-purple-500/20 p-3 rounded-full text-purple-400"><ion-icon name="lock-closed" class="text-2xl"></ion-icon></div><div><h4 class="text-white font-bold">Cofre de Guerra</h4><p class="text-sm text-slate-400">Restante: <span id="dashboard-war-chest" class="font-bold text-purple-400">R$ 0,00</span></p></div></div>
                            <button id="btn-war-action" onclick="openWarChestOptions()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-bold shadow-lg">Guardar</button>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">
                        <div class="p-6 border-b border-slate-700"><h3 class="text-lg font-semibold text-white">Últimas Movimentações</h3></div>
                        <div class="overflow-x-auto"><table class="w-full text-left text-sm text-slate-400"><thead class="bg-slate-700/50 text-xs uppercase font-medium text-slate-300"><tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Descrição</th><th class="px-6 py-3">Categoria</th><th class="px-6 py-3">Conta</th><th class="px-6 py-3 text-right">Valor</th></tr></thead><tbody id="recent-transactions-list" class="divide-y divide-slate-700"></tbody></table></div>
                    </div>
                    
                    <!-- Hidden filters for logic -->
                    <div class="hidden">
                        <input type="date" id="dash-filter-start"><input type="date" id="dash-filter-end">
                        <button id="dash-filter-apply">Aplicar</button><button id="dash-filter-clear">Limpar</button>
                    </div>
                </section>

                <section id="page-transactions" class="page hidden">
                    <h2 class="text-3xl font-bold mb-6">Histórico de Lançamentos</h2>
                    <div class="bg-slate-800 p-4 rounded-lg shadow mb-6 flex flex-wrap gap-4 items-end border border-slate-700">
                        <div><label class="text-xs text-slate-400 block mb-1">Início</label><input type="date" id="tx-filter-start" class="bg-slate-700 border-slate-600 rounded text-white px-3 py-2 outline-none"></div>
                        <div><label class="text-xs text-slate-400 block mb-1">Fim</label><input type="date" id="tx-filter-end" class="bg-slate-700 border-slate-600 rounded text-white px-3 py-2 outline-none"></div>
                        <button id="tx-filter-apply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2"><ion-icon name="filter"></ion-icon> Filtrar</button>
                        <button id="tx-filter-clear" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded">Limpar</button>
                    </div>
                    <div class="bg-slate-800 rounded-lg shadow overflow-hidden border border-slate-700"><div class="overflow-x-auto"><table class="w-full text-left text-sm text-slate-300"><thead class="bg-slate-700 text-slate-200 uppercase text-xs"><tr><th class="p-4">Data</th><th class="p-4">Descrição</th><th class="p-4">Tipo</th><th class="p-4">Categoria</th><th class="p-4">Conta</th><th class="p-4 text-right">Valor</th><th class="p-4 text-center">Ações</th></tr></thead><tbody id="all-transactions-list" class="divide-y divide-slate-700"></tbody></table></div></div>
                </section>
                
                <!-- CREDIT CARDS -->
                <section id="page-cards" class="page hidden">
                    <h2 class="text-3xl font-bold mb-6">Cartões de Crédito</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="cards-container"></div>
                </section>
                
                <!-- CALENDAR HEATMAP -->
                <section id="page-calendar" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-white">Mapa de Calor</h2>
                        <div class="flex gap-2">
                            <button id="cal-prev" class="bg-slate-700 px-3 py-1 rounded text-white hover:bg-slate-600"><ion-icon name="chevron-back"></ion-icon></button>
                            <span id="calendar-month-display" class="text-lg font-bold text-white px-2">Mês/Ano</span>
                            <button id="cal-next" class="bg-slate-700 px-3 py-1 rounded text-white hover:bg-slate-600"><ion-icon name="chevron-forward"></ion-icon></button>
                        </div>
                    </div>
                    <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">
                        <div class="calendar-grid text-xs text-slate-400 uppercase font-bold">
                            <div class="calendar-header">Dom</div><div class="calendar-header">Seg</div><div class="calendar-header">Ter</div><div class="calendar-header">Qua</div><div class="calendar-header">Qui</div><div class="calendar-header">Sex</div><div class="calendar-header">Sáb</div>
                        </div>
                        <div id="calendar-body" class="calendar-grid"></div>
                    </div>
                    <div class="flex gap-4 mt-4 text-xs text-slate-400 justify-end">
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-slate-700 rounded"></div> <span>Sem Movimento</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-500/10 rounded"></div> <span>Baixo</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-500/40 rounded"></div> <span>Alto</span></div>
                    </div>
                </section>
                
                <section id="page-checklist" class="page hidden"><h2 class="text-3xl font-bold mb-6">Checklist Mensal</h2><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 max-w-2xl mx-auto"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-white">Rotina</h3><button id="btn-reset-check" class="text-sm text-blue-400">Reiniciar</button></div><div class="w-full bg-slate-700 rounded-full h-2.5 mb-6"><div id="checklist-progress" class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div><form id="form-add-task" class="flex gap-2 mb-6"><input type="text" id="task-desc" placeholder="Nova tarefa" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required><button type="submit" class="bg-blue-600 px-4 rounded text-white">+</button></form><ul id="checklist-container" class="space-y-2"></ul></div></section>
                
                <section id="page-dre" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-white" id="dre-title">DRE Gerencial</h2>
                        <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                            <button onclick="renderDRE('monthly')" class="px-3 py-1 text-sm rounded bg-slate-700 text-white">Mensal</button>
                            <button onclick="renderDRE('annual')" class="px-3 py-1 text-sm rounded hover:bg-slate-700 text-slate-300">Anual</button>
                        </div>
                    </div>
                    <div id="dre-month-selector" class="mb-4 flex gap-2">
                        <select id="dre-month" class="bg-slate-800 border border-slate-700 text-white rounded p-2"></select>
                        <select id="dre-year" class="bg-slate-800 border border-slate-700 text-white rounded p-2"></select>
                    </div>
                    <div id="dre-waterfall-container" class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6 h-64 relative"><canvas id="dre-waterfall-chart"></canvas></div>
                    <div class="bg-slate-800 rounded-xl shadow-xl p-6 border border-slate-700 overflow-x-auto">
                        <table class="w-full text-left text-slate-300" id="dre-table"></table>
                    </div>
                </section>

                <section id="page-stack" class="page hidden">
                    <h2 class="text-3xl font-bold mb-6" id="stack-title">Gestão de Stack</h2>
                    <!-- PJ Only Simulator -->
                    <div id="stack-simulator" class="bg-slate-800/80 border border-yellow-600/30 p-4 rounded-xl mb-8">
                        <div class="flex justify-between items-center mb-2"><h3 class="text-lg font-bold text-white"><ion-icon name="analytics"></ion-icon> Stress Test Cambial</h3><span id="simulated-rate-display" class="text-yellow-400 font-mono font-bold">Dólar: R$ 5.80</span></div>
                        <input type="range" id="usd-simulator" min="4.50" max="8.00" step="0.10" value="5.80" class="w-full accent-yellow-500 mb-2">
                        <p class="text-xs text-slate-400" id="stack-impact-msg">Impacto Dólar: +R$ 0,00</p>
                    </div>
                    <!-- Tool List -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-fit">
                            <h3 class="text-lg font-bold mb-4 text-white">Adicionar Item</h3>
                            <form id="form-add-tool" class="space-y-4">
                                <input type="text" id="tool-name" placeholder="Nome (ex: Netflix, Zoom)" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="tool-price" placeholder="Valor" step="0.01" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required>
                                    <select id="tool-currency" class="w-full bg-slate-700 border border-slate-600 rounded p-2"><option value="BRL">BRL</option><option value="USD">USD</option></select>
                                </div>
                                <div id="usd-rate-field" class="hidden"><label class="text-xs text-slate-400">Cotação Dólar</label><input type="number" id="tool-rate" value="5.80" step="0.01" class="w-full bg-slate-700 border border-slate-600 rounded p-2"></div>
                                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded font-bold">Adicionar</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2 space-y-3">
                            <div class="flex justify-between items-center bg-slate-800 p-4 rounded border border-slate-700"><span class="text-slate-400">Custo Mensal Total</span><span class="text-xl font-bold text-white" id="stack-total">R$ 0,00</span></div>
                            <div id="stack-list" class="space-y-3"></div>
                        </div>
                    </div>
                </section>
                
                <section id="page-distribution" class="page hidden">
                    <h2 class="text-3xl font-bold mb-6">Simulação de Distribuição</h2>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-8">
                        <h3 class="text-lg font-bold text-white mb-4">Configurar Cap Table</h3>
                        <form id="form-add-dist-rule" class="flex gap-4 items-end bg-slate-700/30 p-4 rounded border border-slate-600">
                            <div class="flex-1"><label class="text-xs text-slate-400">Nome</label><input type="text" id="dist-name" placeholder="Sócio / Reserva" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></div>
                            <div class="w-24"><label class="text-xs text-slate-400">%</label><input type="number" id="dist-pct" placeholder="%" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></div>
                            <div class="w-32"><label class="text-xs text-slate-400">Tipo</label><select id="dist-type" class="w-full bg-slate-700 border border-slate-600 rounded p-2"><option value="partner">Sócio</option><option value="reserve">Reserva</option></select></div>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">Salvar</button>
                        </form>
                        <ul id="dist-rules-list" class="mt-4 space-y-2"></ul>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-white">Simulação</h3>
                            <input type="month" id="dist-month" class="bg-slate-700 border border-slate-600 rounded p-2 text-white">
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-slate-700 p-3 rounded">
                                <p class="text-xs text-slate-400">Lucro Líquido (Mês)</p>
                                <p class="text-xl font-bold text-green-400" id="dist-net-profit">R$ 0,00</p>
                            </div>
                            <div class="bg-yellow-900/20 border border-yellow-600/30 p-3 rounded">
                                <p class="text-xs text-yellow-500">Total Simulado</p>
                                <p class="text-xl font-bold text-yellow-400" id="dist-total">R$ 0,00</p>
                            </div>
                        </div>
                        <table class="w-full text-left text-sm text-slate-300">
                            <thead class="bg-slate-700 text-white uppercase text-xs"><tr><th class="p-3">Beneficiário</th><th class="p-3">Tipo</th><th class="p-3">%</th><th class="p-3 text-right">Valor Calculado</th></tr></thead>
                            <tbody id="dist-sim-body"></tbody>
                        </table>
                    </div>
                </section>

                <section id="page-projections" class="page hidden">
                    <h2 class="text-3xl font-bold mb-2">Projeções & Futuro</h2>
                    <!-- FIRE Calculator (PF) -->
                    <div id="fire-calc-container" class="mb-8 hidden">
                         <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-white bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-red-500">Calculadora F.I.R.E.</h3>
                                <div class="text-right"><p class="text-xs text-slate-400">Patrimônio Investido</p><p class="text-lg font-bold text-white" id="fire-current-equity">R$ 0,00</p></div>
                            </div>
                            <div class="mb-4">
                                <label class="text-xs text-slate-400">Renda Passiva Mensal Desejada</label>
                                <div class="flex gap-2">
                                    <input type="number" id="fire-target-income" value="5000" class="bg-slate-700 border border-slate-600 rounded p-2 text-white w-40">
                                    <button onclick="renderGoals()" class="bg-slate-700 hover:bg-slate-600 px-3 rounded text-white">Calcular</button>
                                </div>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-4 mb-2 overflow-hidden relative">
                                <div id="fire-progress" class="bg-gradient-to-r from-orange-500 to-red-600 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-slate-400">
                                <span>0%</span>
                                <span id="fire-target-equity">Meta: R$ 1.500.000 (Regra x300)</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*Considera apenas saldo em Potes e Wallets (Investimentos).</p>
                         </div>
                    </div>
                    <!-- Projeção de Caixa (PJ/PF) -->
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 h-80 relative mb-6">
                        <canvas id="projection-chart"></canvas>
                    </div>
                    <!-- Launch Events -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-fit max-w-2xl mx-auto">
                        <h3 class="text-lg font-bold mb-4 text-white">Eventos de Lançamento / Metas</h3>
                        <form id="form-add-launch" class="flex flex-wrap gap-3 items-end">
                            <div class="flex-1"><input type="text" id="launch-name" placeholder="Evento" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></div>
                            <div class="w-32"><input type="date" id="launch-date" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></div>
                            <div class="w-24"><input type="number" id="launch-val" placeholder="R$" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></div>
                            <button type="submit" class="bg-blue-600 px-4 py-2 rounded text-white">+</button>
                        </form>
                        <ul id="launch-list" class="mt-4 space-y-2"></ul>
                    </div>
                </section>

                <section id="page-digital-tools" class="page hidden">
                    <h2 class="text-3xl font-bold mb-6 text-white">Ferramentas Digitais</h2>
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 mb-8">
                        <h3 class="text-xl font-bold mb-4 text-white"><ion-icon name="rocket"></ion-icon> Simulador de Escala</h3>
                        <div class="grid md:grid-cols-3 gap-4 items-end">
                            <div><label class="text-xs text-slate-400 block mb-1">Gasto Diário Ads</label><input type="number" id="scale-daily-spend" class="w-full bg-slate-700 border-slate-600 rounded p-2" placeholder="R$ 1000"></div>
                            <div><label class="text-xs text-slate-400 block mb-1">Recebimento (Dias)</label><input type="number" id="scale-receipt-days" class="w-full bg-slate-700 border-slate-600 rounded p-2" value="30"></div>
                            <div><label class="text-xs text-slate-400 block mb-1">Pagamento Cartão (Dias)</label><input type="number" id="scale-card-days" class="w-full bg-slate-700 border-slate-600 rounded p-2" value="30"></div>
                        </div>
                        <button id="btn-calc-scale" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold">Calcular</button>
                        <div id="scale-result" class="mt-4 hidden bg-slate-900 p-4 rounded border border-slate-700">
                            <p class="text-slate-400 text-sm">Necessidade de Capital de Giro:</p>
                            <p class="text-3xl font-bold text-amber-400 mt-1" id="scale-capital-needed">R$ 0,00</p>
                        </div>
                    </div>
                </section>

                <section id="page-goals" class="page hidden"><h2 class="text-3xl font-bold mb-6">Metas (Potes)</h2><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-8"><form id="form-add-goal" class="flex gap-4 items-end"><div class="flex-1"><label class="text-xs text-slate-400">Objetivo</label><input type="text" id="goal-name" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></div><div class="w-32"><label class="text-xs text-slate-400">Valor Alvo</label><input type="number" id="goal-value" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></div><div class="w-32"><label class="text-xs text-slate-400">Data Alvo</label><input type="date" id="goal-date" class="w-full bg-slate-700 border border-slate-600 rounded p-2"></div><div class="w-48"><label class="text-xs text-slate-400">Vincular Conta</label><select id="goal-account-id" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required></select></div><button type="submit" class="bg-blue-600 px-4 py-2 rounded text-white font-bold">Criar</button></form><p id="goal-acc-msg" class="text-xs text-red-400 mt-2 hidden">Crie uma conta do tipo "Pote" primeiro.</p></div><div id="goals-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></section>
                <section id="page-budget" class="page hidden"><h2 class="text-3xl font-bold mb-6">Orçamento</h2><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-8"><div class="flex justify-between mb-4"><form id="form-budget" class="flex gap-2 items-end flex-1"><input type="month" id="budget-month-input" class="bg-slate-700 border border-slate-600 rounded p-2 text-white"><select id="budget-category" class="bg-slate-700 border border-slate-600 rounded p-2 text-white flex-1"></select><input type="number" id="budget-limit" placeholder="Limite R$" class="bg-slate-700 border border-slate-600 rounded p-2 text-white w-32"><button type="submit" class="bg-blue-600 px-4 py-2 rounded text-white">Definir</button></form><button onclick="cloneBudget()" class="ml-4 text-sm text-blue-400">Clonar Mês Anterior</button></div><div id="budget-list" class="space-y-3"></div></div></section>
                <section id="page-balance" class="page hidden"><h2 class="text-3xl font-bold mb-6">Balanço Patrimonial</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8"><div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h4 class="text-sm text-slate-400">Liquidez Corrente</h4><p class="text-2xl font-bold text-white" id="bal-liquidity">--</p></div><div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><h4 class="text-sm text-slate-400">Patrimônio Líquido</h4><p class="text-2xl font-bold text-blue-400" id="balance-equity">R$ 0,00</p></div></div><div class="grid md:grid-cols-2 gap-8"><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-64"><canvas id="balance-history-chart"></canvas></div><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-64"><canvas id="balance-allocation-chart"></canvas></div></div></section>
                <section id="page-import_export" class="page hidden"><h2 class="text-3xl font-bold mb-6">Dados & Backup</h2><div class="grid md:grid-cols-2 gap-8"><div class="bg-slate-800 p-6 rounded-xl border border-slate-700"><h3 class="text-lg font-bold text-white mb-4">Backup Unificado (PJ + PF)</h3><button id="btn-export" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded mb-4">Baixar Backup Completo</button><input type="file" id="file-backup-input" class="hidden"><button onclick="document.getElementById('file-backup-input').click()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded">Restaurar Backup</button><button id="btn-clear-all" class="w-full mt-8 border border-red-500/50 text-red-400 hover:bg-red-500/10 py-3 rounded">Zerar Tudo (Reset Fábrica)</button></div><div class="bg-slate-800 p-6 rounded-xl border border-slate-700"><h3 class="text-lg font-bold text-white mb-4">Importar Extrato</h3><div id="drop-zone" class="border-2 border-dashed border-slate-600 rounded p-8 text-center cursor-pointer hover:bg-slate-700/30"><p class="text-slate-400">Arraste OFX ou CSV</p><input type="file" id="import-bank-file" class="hidden" accept=".ofx,.csv"><button onclick="document.getElementById('import-bank-file').click()" class="mt-4 bg-slate-600 px-4 py-2 rounded text-white">Selecionar</button></div><div id="import-preview" class="mt-4 hidden"><h4 class="text-sm font-bold text-white">Prévia</h4><div class="max-h-40 overflow-y-auto border border-slate-700 rounded"><table class="w-full text-xs text-left text-slate-300"><tbody id="import-list"></tbody></table></div><button id="btn-confirm-import" class="w-full bg-green-600 text-white py-2 rounded mt-2">Confirmar Importação</button></div></div></div></section>
                <section id="page-accounts" class="page hidden"><h2 class="text-3xl font-bold mb-6">Contas Bancárias</h2><div class="grid md:grid-cols-3 gap-8"><div class="bg-slate-800 p-6 rounded-lg h-fit border border-slate-700"><h3 class="text-white font-semibold mb-4">Nova Conta</h3><form id="form-save-account" class="space-y-4"><input type="hidden" id="account-id"><input type="text" id="account-name" placeholder="Nome" class="w-full bg-slate-700 p-2 rounded border-slate-600" required><select id="account-type" class="w-full bg-slate-700 p-2 rounded border-slate-600" onchange="toggleCardFields()"><option value="operational">Conta Corrente</option><option value="goal_pot">Pote / Investimento</option><option value="wallet">Wallet / Plataforma</option><option value="credit_card">Cartão de Crédito</option></select><input type="number" id="account-initial-balance" step="0.01" placeholder="Saldo Inicial" class="w-full bg-slate-700 p-2 rounded border-slate-600" required><div id="card-fields" class="hidden space-y-2"><input type="number" id="card-limit" placeholder="Limite Total" class="w-full bg-slate-700 p-2 rounded border-slate-600"><div class="grid grid-cols-2 gap-2"><input type="number" id="card-closing" placeholder="Dia Fech." class="w-full bg-slate-700 p-2 rounded border-slate-600"><input type="number" id="card-due" placeholder="Dia Venc." class="w-full bg-slate-700 p-2 rounded border-slate-600"></div></div><div class="flex gap-2"><button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Salvar</button><button type="button" onclick="cancelEditAccount()" class="w-full bg-slate-700 text-slate-300 py-2 rounded hidden" id="btn-cancel-acc">Cancelar</button></div></form></div><div class="md:col-span-2 space-y-4" id="accounts-list"></div></div></section>
                <section id="page-recurring" class="page hidden"><h2 class="text-3xl font-bold mb-6">Recorrências</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="bg-slate-800 p-6 rounded-xl h-fit border border-slate-700"><h3 class="text-lg font-bold mb-4">Agendar</h3><form id="form-recurring" class="space-y-4"><input type="text" id="rec-desc" placeholder="Descrição" class="w-full bg-slate-700 border-slate-600 rounded p-2" required><div class="grid grid-cols-2 gap-2"><input type="number" id="rec-day" placeholder="Dia" min="1" max="31" class="w-full bg-slate-700 border-slate-600 rounded p-2" required><input type="number" id="rec-amount" placeholder="Valor" class="w-full bg-slate-700 border-slate-600 rounded p-2" required></div><select id="rec-type" class="w-full bg-slate-700 border-slate-600 rounded p-2"><option value="despesa">Despesa</option><option value="receita">Receita</option></select><select id="rec-category" class="w-full bg-slate-700 border-slate-600 rounded p-2"></select><select id="rec-account" class="w-full bg-slate-700 border-slate-600 rounded p-2"></select><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded">Salvar</button></form></div><div class="lg:col-span-2 space-y-4" id="recurring-list"></div></div></section>
                <section id="page-categories" class="page hidden"><h2 class="text-3xl font-bold mb-6">Plano de Contas</h2><div class="grid md:grid-cols-2 gap-8"><div class="bg-slate-800 p-6 rounded-lg border border-slate-700"><h3 class="text-green-400 font-bold mb-4 border-b border-slate-700 pb-2">Entradas</h3><ul id="receita-categories-list" class="space-y-2 text-sm"></ul></div><div class="bg-slate-800 p-6 rounded-lg border border-slate-700"><h3 class="text-red-400 font-bold mb-4 border-b border-slate-700 pb-2">Saídas</h3><ul id="despesa-categories-list" class="space-y-2 text-sm"></ul><div class="mt-6 pt-6 border-t border-slate-700"><h4 class="text-white font-semibold mb-2">Adicionar</h4><form id="form-add-category" class="space-y-3"><input type="text" id="category-name" placeholder="Nome" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required><div class="flex gap-2"><select id="category-type" class="bg-slate-700 p-2 rounded border-slate-600 w-1/2"></select><select id="category-dre-account" class="bg-slate-700 p-2 rounded border-slate-600 w-1/2"></select></div><button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Salvar</button></form></div></div></div></section>
                <section id="page-automation" class="page hidden"><h2 class="text-3xl font-bold mb-6">Automação & Tags</h2><div class="grid md:grid-cols-2 gap-8"><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-fit"><h3 class="text-lg font-bold mb-4 text-white">Tags & Regras</h3><form id="form-add-tag" class="flex gap-2 mb-4"><input type="text" id="tag-name" placeholder="Nova Tag" class="w-full bg-slate-700 border border-slate-600 rounded p-2" required><button type="submit" class="bg-blue-600 px-4 rounded text-white">+</button></form><ul id="tags-list" class="mb-6 space-y-2"></ul><h4 class="font-bold text-white mb-2">Regras de Categorização</h4><form id="form-add-rule" class="space-y-2 mb-4"><input type="text" id="rule-term" placeholder="Se contém..." class="w-full bg-slate-700 border border-slate-600 rounded p-2" required><div class="flex gap-2"><select id="rule-category" class="w-1/2 bg-slate-700 border border-slate-600 rounded p-2"></select><select id="rule-tag" class="w-1/2 bg-slate-700 border border-slate-600 rounded p-2"><option value="">Sem Tag</option></select></div><button type="submit" class="w-full bg-purple-600 py-1 rounded text-white text-sm">Criar Regra</button></form><ul id="rules-list" class="space-y-2 max-h-40 overflow-y-auto"></ul></div><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-fit" id="auto-config-panel"><!-- Content populated by JS based on profile --></div></div></section>
                <section id="page-reports" class="page hidden"><h2 class="text-3xl font-bold mb-6">Relatórios</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="bg-slate-800 p-6 rounded-xl border border-slate-700"><h3 class="text-lg font-bold mb-4">Despesas por Categoria</h3><div class="h-64"><canvas id="expense-chart"></canvas></div></div><div class="bg-slate-800 p-6 rounded-xl border border-slate-700"><h3 class="text-lg font-bold mb-4">Curva ABC (Pareto)</h3><div class="h-64"><canvas id="pareto-chart"></canvas></div></div><div class="bg-slate-800 p-6 rounded-xl border border-slate-700 md:col-span-2"><h3 class="text-lg font-bold mb-4">Ponto de Equilíbrio</h3><p class="text-sm text-slate-400 mb-2">Quanto precisa faturar para cobrir custos fixos.</p><p class="text-3xl font-bold text-white" id="break-even-val">R$ 0,00</p></div></div></section>

            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="transaction-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 w-full max-w-lg rounded-xl shadow-2xl border border-slate-700"><div class="flex justify-between items-center p-6 border-b border-slate-700"><h3 class="text-xl font-bold text-white">Novo Lançamento</h3><button onclick="closeModal()" class="text-slate-400 hover:text-white"><ion-icon name="close" class="text-2xl"></ion-icon></button></div><form id="form-add-transaction" class="p-6 space-y-4"><input type="hidden" id="transaction-id"><div><label class="block text-sm text-slate-400 mb-1">Tipo</label><div class="grid grid-cols-3 gap-2"><label class="cursor-pointer"><input type="radio" name="tx-type" value="receita" class="peer hidden" checked onchange="toggleTxFields()"><div class="peer-checked:bg-green-600 peer-checked:text-white bg-slate-700 text-slate-300 py-2 text-center rounded transition">Receita</div></label><label class="cursor-pointer"><input type="radio" name="tx-type" value="despesa" class="peer hidden" onchange="toggleTxFields()"><div class="peer-checked:bg-red-600 peer-checked:text-white bg-slate-700 text-slate-300 py-2 text-center rounded transition">Despesa</div></label><label class="cursor-pointer"><input type="radio" name="tx-type" value="transfer" class="peer hidden" onchange="toggleTxFields()"><div class="peer-checked:bg-blue-600 peer-checked:text-white bg-slate-700 text-slate-300 py-2 text-center rounded transition">Transf.</div></label></div></div><div><label class="block text-sm text-slate-400 mb-1">Descrição</label><input type="text" id="tx-desc" class="w-full bg-slate-700 border-slate-600 rounded p-2 outline-none" required></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm text-slate-400 mb-1">Valor</label><input type="number" id="tx-amount" step="0.01" class="w-full bg-slate-700 border-slate-600 rounded p-2 outline-none" required></div><div><label class="block text-sm text-slate-400 mb-1">Data</label><input type="date" id="tx-date" class="w-full bg-slate-700 border-slate-600 rounded p-2 outline-none" required></div></div><div id="standard-fields" class="space-y-4"><div><label class="block text-sm text-slate-400 mb-1">Categoria</label><select id="tx-category" class="w-full bg-slate-700 border-slate-600 rounded p-2 outline-none"></select></div><div><label class="block text-sm text-slate-400 mb-1">Conta</label><select id="tx-account" class="w-full bg-slate-700 border-slate-600 rounded p-2 outline-none"></select></div><div class="flex items-center gap-2"><input type="checkbox" id="tx-pending" class="w-4 h-4 rounded bg-slate-700 border-slate-600"><label for="tx-pending" class="text-sm text-slate-300">Marcar como Pendente (Agendado)</label></div><div id="pf-salary-option" class="hidden items-center gap-2 bg-purple-900/20 p-2 rounded border border-purple-500/30"><input type="checkbox" id="tx-salary-link" class="w-4 h-4 rounded bg-slate-700 border-slate-600"><label for="tx-salary-link" class="text-sm text-purple-300">Enviar como Receita para Pessoal?</label></div><div id="pj-reimburse-option" class="hidden items-center gap-2 bg-blue-900/20 p-2 rounded border border-blue-500/30"><input type="checkbox" id="tx-reimburse-link" class="w-4 h-4 rounded bg-slate-700 border-slate-600"><label for="tx-reimburse-link" class="text-sm text-blue-300">Reembolsável (PJ)</label></div><div id="installments-field" class="hidden"><label class="text-sm text-slate-400">Parcelas (Cartão)</label><input type="number" id="tx-installments" value="1" min="1" class="w-full bg-slate-700 border-slate-600 rounded p-2"></div></div><div id="transfer-fields" class="space-y-4 hidden"><div class="bg-blue-900/20 p-4 rounded border border-blue-500/30 space-y-2"><div><label class="block text-sm text-blue-300">De (Saída)</label><select id="tx-source" class="w-full bg-slate-700 border-slate-600 rounded p-2"></select></div><div class="text-center text-blue-400"><ion-icon name="arrow-down"></ion-icon></div><div><label class="block text-sm text-blue-300">Para (Entrada)</label><select id="tx-dest" class="w-full bg-slate-700 border-slate-600 rounded p-2"></select></div></div></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded mt-4">Salvar</button></form></div></div>
    <div id="pay-card-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 w-full max-w-md rounded-xl border border-slate-700"><div class="p-6"><h3 class="text-xl font-bold text-white mb-4">Pagar Fatura</h3><p class="text-slate-400 text-sm mb-4">Valor: <span id="pay-card-amount" class="text-white font-bold"></span></p><label class="block text-sm text-slate-400 mb-1">Pagar com:</label><select id="pay-card-source" class="w-full bg-slate-700 border-slate-600 rounded p-2 mb-4"></select><button onclick="confirmPayCard()" class="w-full bg-green-600 text-white py-2 rounded font-bold">Confirmar</button><button onclick="document.getElementById('pay-card-modal').classList.add('hidden')" class="w-full text-slate-500 mt-2">Cancelar</button></div></div></div>
    <div id="tax-options-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 w-full max-w-md rounded-xl border border-slate-700"><div class="p-6 text-center"><h3 class="text-xl font-bold text-white mb-2">Gerenciar Impostos</h3><p class="text-slate-400 text-sm mb-4">Valor Sugerido: <span id="tax-suggested-val" class="font-bold text-white"></span></p><input type="number" id="tax-action-val" class="w-full bg-slate-700 border-slate-600 rounded p-2 mb-4 text-white text-center"><div class="space-y-3"><div class="bg-slate-700/50 p-2 rounded"><label class="text-xs text-slate-400">Pagar (Despesa)</label><select id="tax-pay-acc" class="w-full bg-slate-700 border-slate-600 rounded p-1 text-xs mb-1"></select><button onclick="openTaxAction('pay')" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold">Pagar Agora</button></div><div class="bg-slate-700/50 p-2 rounded"><label class="text-xs text-slate-400">Reservar (Transferência)</label><select id="tax-res-acc" class="w-full bg-slate-700 border-slate-600 rounded p-1 text-xs mb-1"></select><button onclick="openTaxAction('transfer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold">Reservar no Pote</button></div><button onclick="document.getElementById('tax-options-modal').classList.add('hidden')" class="w-full text-slate-500 mt-2">Cancelar</button></div></div></div></div>
    <div id="war-chest-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 w-full max-w-md rounded-xl border border-slate-700"><div class="p-6 text-center"><h3 class="text-xl font-bold text-white mb-2">Aporte Cofre de Guerra</h3><p class="text-slate-400 text-sm mb-4">Valor Alvo: <span id="war-suggested-val" class="font-bold text-purple-400"></span></p><input type="number" id="war-action-val" class="w-full bg-slate-700 border-slate-600 rounded p-2 mb-4 text-white text-center"><div class="grid grid-cols-2 gap-2 mb-4 text-left"><div class="col-span-2"><label class="text-xs text-slate-400">Sair de:</label><select id="war-source" class="w-full bg-slate-700 border-slate-600 rounded p-2"></select></div><div class="col-span-2"><label class="text-xs text-slate-400">Para Pote:</label><select id="war-dest" class="w-full bg-slate-700 border-slate-600 rounded p-2"></select></div></div><button onclick="confirmWarChest()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded font-bold">Confirmar Transferência</button><button onclick="document.getElementById('war-chest-modal').classList.add('hidden')" class="w-full text-slate-500 mt-2">Cancelar</button></div></div></div>
    <div id="holding-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 w-full max-w-2xl rounded-xl border border-slate-700 p-8 relative"><button onclick="document.getElementById('holding-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white"><ion-icon name="close" class="text-2xl"></ion-icon></button><h2 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-yellow-400 to-amber-600 bg-clip-text text-transparent">Relatório Holding (Patrimônio Global)</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-slate-700/50 p-4 rounded text-center"><p class="text-sm text-slate-400">Caixa Empresa (PJ)</p><p class="text-xl font-bold text-blue-400" id="hold-pj">R$ 0,00</p></div><div class="bg-slate-700/50 p-4 rounded text-center"><p class="text-sm text-slate-400">Caixa Pessoal (PF)</p><p class="text-xl font-bold text-purple-400" id="hold-pf">R$ 0,00</p></div><div class="bg-slate-700/50 p-4 rounded text-center"><p class="text-sm text-slate-400">Dívidas Totais</p><p class="text-xl font-bold text-red-400" id="hold-debt">R$ 0,00</p></div></div><div class="text-center p-6 bg-slate-900 rounded-xl border border-slate-700"><p class="text-sm text-slate-400 uppercase tracking-widest mb-2">Patrimônio Líquido Total</p><p class="text-5xl font-bold text-green-400" id="hold-total">R$ 0,00</p></div></div></div>
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 z-[60] hidden flex items-center justify-center p-4"><div class="bg-slate-800 p-6 rounded-lg border border-slate-600 max-w-sm text-center"><h3 class="text-xl font-bold text-white mb-2">Tem certeza?</h3><p class="text-slate-400 mb-4">Essa ação apagará TODOS os dados do navegador para sempre.</p><div class="flex gap-2 justify-center"><button onclick="confirmClear()" class="bg-red-600 text-white px-4 py-2 rounded">Sim, Apagar</button><button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="bg-slate-600 text-white px-4 py-2 rounded">Cancelar</button></div></div></div>

    <script>
        const SYSTEM_TRANSFER_ID = 'sys-transfer-cat';
        const PJ_CATS = [{ id: 'c1', name: 'Vendas', type: 'receita', dre: 'receita_bruta' }, { id: 'c2', name: 'Salários', type: 'despesa', dre: 'despesas_op' }, { id: 'c3', name: 'Impostos', type: 'despesa', dre: 'impostos' }, { id: SYSTEM_TRANSFER_ID, name: 'Transferência', type: 'transfer', dre: 'none' }];
        const PF_CATS = [{ id: 'pf1', name: 'Salário/Pró-labore', type: 'receita', sub: 'renda' }, { id: 'pf2', name: 'Aluguel/Moradia', type: 'despesa', sub: 'essencial' }, { id: 'pf3', name: 'Mercado', type: 'despesa', sub: 'essencial' }, { id: 'pf4', name: 'Lazer', type: 'despesa', sub: 'estilo' }, { id: 'pf5', name: 'Investimentos', type: 'despesa', sub: 'objetivos' }, { id: SYSTEM_TRANSFER_ID, name: 'Transferência', type: 'transfer', sub: 'none' }];
        let DB = { PJ: null, PF: null }, currentProfile = 'PJ', app = null, charts = {};

        function initDB() {
            const stored = localStorage.getItem('financeHub_FULL_v14_3');
            if (stored) DB = JSON.parse(stored); else { DB = { PJ: createEmptyState('PJ'), PF: createEmptyState('PF') }; saveData(); }
            const lastProf = localStorage.getItem('financeHub_LastProfile');
            if(lastProf && (lastProf === 'PJ' || lastProf === 'PF')) currentProfile = lastProf;
            app = DB[currentProfile]; applyTheme();
        }
        function createEmptyState(type) { return { transactions: [], accounts: [], categories: type === 'PJ' ? JSON.parse(JSON.stringify(PJ_CATS)) : JSON.parse(JSON.stringify(PF_CATS)), goals: [], budgets: [], recurring: [], tags: [], rules: [], stack: [], checklist: [], launchEvents: [], capTable: [], taxRate: 6.0, warRate: 10.0, checklistMonth: '' }; }
        function saveData() { localStorage.setItem('financeHub_FULL_v14_3', JSON.stringify(DB)); localStorage.setItem('financeHub_LastProfile', currentProfile); }
        function switchProfile(prof) { 
            currentProfile = prof; app = DB[currentProfile]; 
            if (!app) { DB[currentProfile] = createEmptyState(currentProfile); app = DB[currentProfile]; } 
            saveData(); applyTheme(); updateNav(); 
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden')); 
            document.getElementById('page-dashboard').classList.remove('hidden'); 
            updateUI(); 
        }
        function applyTheme() { 
            const b = document.body; 
            if (currentProfile === 'PF') { b.classList.remove('theme-pj'); b.classList.add('theme-pf'); document.getElementById('btn-prof-pf').classList.add('text-white','bg-purple-600','shadow'); document.getElementById('btn-prof-pf').classList.remove('text-slate-400'); document.getElementById('btn-prof-pj').classList.remove('text-white','bg-blue-600','shadow'); document.getElementById('btn-prof-pj').classList.add('text-slate-400'); } 
            else { b.classList.remove('theme-pf'); b.classList.add('theme-pj'); document.getElementById('btn-prof-pj').classList.add('text-white','bg-blue-600','shadow'); document.getElementById('btn-prof-pj').classList.remove('text-slate-400'); document.getElementById('btn-prof-pf').classList.remove('text-white','bg-purple-600','shadow'); document.getElementById('btn-prof-pf').classList.add('text-slate-400'); }
        }
        function seedData() { DB = { PJ: createEmptyState('PJ'), PF: createEmptyState('PF') }; DB.PJ.accounts.push({ id: 'acc-main-pj', name: 'Conta Principal', type: 'operational', initialBalance: 0 }); DB.PF.accounts.push({ id: 'acc-main-pf', name: 'Conta Corrente', type: 'operational', initialBalance: 0 }); app = DB[currentProfile]; saveData(); updateUI(); }
        
        function getAccountBalance(id) { const acc = app.accounts.find(a => a.id === id); if (!acc) return 0; let bal = acc.initialBalance; app.transactions.filter(t => t.accountId === id && !t.pending).forEach(t => { if (acc.type === 'credit_card') { if (t.type === 'despesa') bal += t.amount; else bal -= t.amount; } else { if (t.type === 'receita') bal += t.amount; else bal -= t.amount; } }); return bal; }
        function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
        
        function updateNav() {
            const l = document.getElementById('nav-list'); l.innerHTML = '';
            const items = [{id:'dashboard',i:'pie-chart',t:'Dashboard'},{id:'transactions',i:'list',t:'Lançamentos'},{id:'cards',i:'card',t:'Cartões'},{id:'calendar',i:'calendar',t:'Calendário'}];
            items.forEach(i=>l.innerHTML+=`<li><a class="nav-link ${i.id==='dashboard'?'active':''}" data-page="${i.id}"><ion-icon name="${i.i}-outline" class="text-lg"></ion-icon><span>${i.t}</span></a></li>`);
            if(currentProfile==='PJ') l.innerHTML+=`<li class="pt-6 pb-2 px-3 text-[10px] font-bold text-slate-500 uppercase">Gestão</li><li><a class="nav-link" data-page="projections"><ion-icon name="trending-up-outline" class="text-lg"></ion-icon><span>Fluxo de Caixa</span></a></li><li><a class="nav-link" data-page="checklist"><ion-icon name="checkbox-outline" class="text-lg"></ion-icon><span>Checklist</span></a></li><li><a class="nav-link" data-page="stack"><ion-icon name="layers-outline" class="text-lg"></ion-icon><span>Stack</span></a></li><li><a class="nav-link" data-page="digital-tools"><ion-icon name="rocket-outline" class="text-lg"></ion-icon><span>Ferramentas</span></a></li><li><a class="nav-link" data-page="dre"><ion-icon name="calculator-outline" class="text-lg"></ion-icon><span>DRE</span></a></li><li><a class="nav-link" data-page="distribution"><ion-icon name="git-network-outline" class="text-lg"></ion-icon><span>Distribuição</span></a></li>`;
            else l.innerHTML+=`<li class="pt-6 pb-2 px-3 text-[10px] font-bold text-slate-500 uppercase">Vida</li><li><a class="nav-link" data-page="projections"><ion-icon name="flame-outline" class="text-lg"></ion-icon><span>FIRE</span></a></li><li><a class="nav-link" data-page="stack"><ion-icon name="albums-outline" class="text-lg"></ion-icon><span>Assinaturas</span></a></li>`;
            l.innerHTML+=`<li class="pt-6 pb-2 px-3 text-[10px] font-bold text-slate-500 uppercase">Estratégia</li><li><a class="nav-link" data-page="goals"><ion-icon name="flag-outline" class="text-lg"></ion-icon><span>${currentProfile==='PJ'?'Potes':'Sonhos'}</span></a></li><li><a class="nav-link" data-page="budget"><ion-icon name="archive-outline" class="text-lg"></ion-icon><span>Orçamento</span></a></li><li><a class="nav-link" data-page="balance"><ion-icon name="book-outline" class="text-lg"></ion-icon><span>${currentProfile==='PJ'?'Balanço':'Patrimônio'}</span></a></li><li><a class="nav-link" data-page="reports"><ion-icon name="analytics-outline" class="text-lg"></ion-icon><span>Relatórios</span></a></li><li class="pt-6 pb-2 px-3 text-[10px] font-bold text-slate-500 uppercase">Config</li><li><a class="nav-link" data-page="categories"><ion-icon name="pricetags-outline" class="text-lg"></ion-icon><span>Categorias</span></a></li><li><a class="nav-link" data-page="automation"><ion-icon name="flash-outline" class="text-lg"></ion-icon><span>Automação</span></a></li><li><a class="nav-link" data-page="accounts"><ion-icon name="wallet-outline" class="text-lg"></ion-icon><span>Contas</span></a></li><li><a class="nav-link" data-page="import_export"><ion-icon name="swap-horizontal-outline" class="text-lg"></ion-icon><span>Dados</span></a></li><li><a class="nav-link" data-page="recurring"><ion-icon name="repeat-outline" class="text-lg"></ion-icon><span>Recorrências</span></a></li>`;
            document.querySelectorAll('.nav-link').forEach(lnk=>{ lnk.addEventListener('click',(e)=>{ e.preventDefault(); document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active')); lnk.classList.add('active'); document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden')); const pid=lnk.getAttribute('data-page'); document.getElementById('page-'+pid).classList.remove('hidden'); if(pid==='cards') renderCards(); if(pid==='calendar') renderCal(); if(pid==='dre') renderDRE(); if(pid==='stack') renderStack(); if(pid==='budget') renderBudget(); if(pid==='projections') { renderProj(); renderLaunchList(); } if(pid==='goals') renderGoals(); if(pid==='balance') renderBalance(); if(pid==='distribution') renderDist(); if(pid==='reports') renderCharts(); if(pid==='categories') renderCats(); if(pid==='automation') renderAuto(); if(pid==='checklist') renderChecklist(); if(pid==='recurring') { popRecOptions(); renderRec(); } if(pid==='accounts') renderAccs(); }); });
        }

        function updateUI() {
            const start = document.getElementById('dash-filter-start').value, end = document.getElementById('dash-filter-end').value, useFilter = start && end;
            let r=0, d=0, totalBal=0; const today=new Date();
            app.transactions.forEach(t => { if(t.categoryId===SYSTEM_TRANSFER_ID || t.pending) return; const dt=new Date(t.date); if(useFilter){ if(dt<new Date(start)||dt>new Date(end)) return; } else { if(dt.getMonth()!==today.getMonth()) return; } if(t.type==='receita') r+=t.amount; if(t.type==='despesa') d+=t.amount; });
            app.accounts.forEach(a => { const b=getAccountBalance(a.id); if(a.type!=='credit_card') totalBal+=b; else totalBal-=b; });
            document.getElementById('dashboard-saldo-consolidado').innerText=formatCurrency(totalBal); document.getElementById('dashboard-receita').innerText=formatCurrency(r); document.getElementById('dashboard-despesa').innerText=formatCurrency(d);
            
            if(currentProfile==='PJ'){
                document.getElementById('widget-runway').classList.remove('hidden'); document.getElementById('widget-503020').classList.add('hidden'); document.getElementById('widget-tax').classList.remove('hidden'); document.getElementById('widget-war').classList.remove('hidden');
                const fixed = app.recurring.filter(x => x.type === 'despesa').reduce((s,i) => s+i.amount, 0); const runway = fixed > 0 ? (totalBal / fixed).toFixed(1) : (totalBal > 0 ? "∞" : "0"); document.getElementById('dashboard-stress-test').innerText = runway + " meses";
                const taxR = app.taxRate||6, warR=app.warRate||10, paidTax=app.transactions.filter(t=>t.type==='despesa'&&t.description.includes('[IMPOSTO]')).reduce((s,t)=>s+t.amount,0), paidWar=app.transactions.filter(t=>t.type==='despesa'&&t.description.includes('[COFRE]')).reduce((s,t)=>s+t.amount,0);
                document.getElementById('dashboard-tax-provision').innerText=formatCurrency(Math.max(0, (r*(taxR/100))-paidTax)); document.getElementById('dashboard-war-chest').innerText=formatCurrency(Math.max(0, (r*(warR/100))-paidWar));
            } else {
                document.getElementById('widget-runway').classList.add('hidden'); document.getElementById('widget-503020').classList.remove('hidden'); document.getElementById('widget-tax').classList.add('hidden'); document.getElementById('widget-war').classList.add('hidden');
                let ess=0, lif=0, obj=0, tot=0; app.transactions.forEach(t=>{ if(t.type!=='despesa'||t.pending) return; const cat=app.categories.find(c=>c.id===t.categoryId); if(cat){ if(cat.sub==='essencial') ess+=t.amount; else if(cat.sub==='estilo') lif+=t.amount; else if(cat.sub==='objetivos') obj+=t.amount; } tot+=t.amount; });
                const pe = tot?Math.round((ess/tot)*100):0, pl = tot?Math.round((lif/tot)*100):0, po = tot?Math.round((obj/tot)*100):0;
                document.getElementById('val-essencial').innerText=pe+"%"; document.getElementById('val-estilo').innerText=pl+"%"; document.getElementById('val-objetivos').innerText=po+"%";
                if(charts.rule) charts.rule.destroy(); const ctx=document.getElementById('chart-503020'); charts.rule = new Chart(ctx, {type:'doughnut',data:{labels:['Essencial','Estilo','Objetivos'],datasets:[{data:[pe,pl,po],backgroundColor:['#93c5fd','#c084fc','#86efac'],borderWidth:0}]},options:{responsive:true,plugins:{legend:{display:false}}}});
            }
            renderTxTable();
        }
        
        // CALENDAR HEATMAP
        let currentCalendarMonth = new Date();
        function renderCal() {
            const grid = document.getElementById('calendar-body');
            if(!grid) return;
            grid.innerHTML = '';
            
            const y = currentCalendarMonth.getFullYear(), m = currentCalendarMonth.getMonth();
            document.getElementById('calendar-month-display').innerText = new Date(y, m).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            // Blanks
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="min-h-[80px] bg-slate-800/50"></div>`;
            }
            
            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                // Count transactions for heatmap intensity
                const count = app.transactions.filter(t => t.date === dateStr).length;
                let intensityClass = '';
                if (count > 0) {
                    if (count > 5) intensityClass = 'heat-high';
                    else if (count > 2) intensityClass = 'heat-med';
                    else intensityClass = 'heat-low';
                }
                
                grid.innerHTML += `
                    <div class="calendar-day ${intensityClass} border border-slate-700/50">
                        <span class="text-xs font-bold text-slate-500">${d}</span>
                        ${count > 0 ? `<div class="mt-auto self-end"><span class="text-[10px] bg-slate-900/50 px-1 rounded text-slate-400">${count} mov.</span></div>` : ''}
                    </div>
                `;
            }
        }
        document.getElementById('cal-prev').onclick = () => { currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1); renderCal(); };
        document.getElementById('cal-next').onclick = () => { currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1); renderCal(); };

        // ACCOUNTS LIST RENDER
        window.renderAccs = () => {
            const l = document.getElementById('accounts-list');
            if(!l) return;
            l.innerHTML = '';
            if(app.accounts.length === 0) {
                 l.innerHTML = '<p class="text-slate-500 text-center">Nenhuma conta cadastrada.</p>';
                 return;
            }
            app.accounts.forEach(a => {
                const b = getAccountBalance(a.id);
                l.innerHTML += `
                <div class="flex justify-between items-center bg-slate-700 p-4 rounded border border-slate-600 relative overflow-hidden group">
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${a.type==='operational'?'bg-blue-500':a.type==='credit_card'?'bg-red-500':'bg-amber-500'}"></div>
                    <div class="pl-2">
                        <h4 class="font-bold text-white">${a.name}</h4>
                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400">
                            ${a.type==='credit_card'?'Cartão de Crédito':(a.type==='operational'?'Operacional':'Pote/Wallet')}
                        </span>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-mono ${b>=0?'text-green-400':'text-red-400'}">${formatCurrency(b)}</p>
                        <div class="flex justify-end gap-2 mt-1">
                            <button onclick="editAcc('${a.id}')" class="text-xs text-blue-400 hover:text-blue-300">Editar</button>
                            <button onclick="delAcc('${a.id}')" class="text-xs text-slate-500 hover:text-red-500">Excluir</button>
                        </div>
                    </div>
                </div>`;
            });
        };
        window.editAcc = (id) => {
            const a = app.accounts.find(x => x.id === id);
            if(!a) return;
            document.getElementById('account-id').value = a.id;
            document.getElementById('account-name').value = a.name;
            document.getElementById('account-type').value = a.type;
            document.getElementById('account-initial-balance').value = a.initialBalance;
            if(a.type === 'credit_card') {
                document.getElementById('card-fields').classList.remove('hidden');
                document.getElementById('card-limit').value = a.limit || '';
                document.getElementById('card-closing').value = a.closingDay || '';
                document.getElementById('card-due').value = a.dueDay || '';
            } else {
                document.getElementById('card-fields').classList.add('hidden');
            }
            document.getElementById('btn-cancel-acc').classList.remove('hidden');
            window.scrollTo({top:0, behavior:'smooth'});
        };
        window.delAcc = (id) => {
            if(confirm('Tem certeza? Isso apagará o saldo calculado.')) {
                app.accounts = app.accounts.filter(a => a.id !== id);
                saveData();
                updateUI();
                renderAccs();
                renderCards();
            }
        };

        // CREDIT CARDS
        window.renderCards = () => {
            const container = document.getElementById('cards-container');
            if (!container) return;
            container.innerHTML = '';
            const cards = app.accounts.filter(a => a.type === 'credit_card');
            
            if (cards.length === 0) {
                container.innerHTML = '<p class="text-slate-500 col-span-3 text-center py-10">Nenhum cartão cadastrado.</p>';
                return;
            }
            
            cards.forEach(c => {
                const invoice = getAccountBalance(c.id); // Usually negative for debt
                const limit = c.limit || 0;
                const used = Math.abs(invoice);
                const available = limit - used;
                const pct = limit > 0 ? (used / limit) * 100 : 0;
                
                container.innerHTML += `
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <ion-icon name="card" class="text-6xl text-blue-400"></ion-icon>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-1">${c.name}</h3>
                        <p class="text-xs text-slate-400 mb-6">Fecha dia ${c.closingDay || '--'} • Vence dia ${c.dueDay || '--'}</p>
                        
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-400">Fatura Atual</span>
                                    <span class="font-mono font-bold text-white">${formatCurrency(Math.abs(invoice))}</span>
                                </div>
                                <div class="w-full bg-slate-700 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(pct, 100)}%"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1 text-slate-500">
                                    <span>Disp: ${formatCurrency(available)}</span>
                                    <span>Lim: ${formatCurrency(limit)}</span>
                                </div>
                            </div>
                            
                            <button onclick="openPayCard('${c.id}', ${Math.abs(invoice)})" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-sm font-bold border border-slate-600">
                                Pagar Fatura
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        window.openPayCard = (id, val) => {
            payCardId = id;
            document.getElementById('pay-card-amount').innerText = formatCurrency(val);
            const sel = document.getElementById('pay-card-source');
            sel.innerHTML = '';
            app.accounts.forEach(a => {
                if (a.type === 'operational' || a.type === 'wallet') {
                    sel.innerHTML += `<option value="${a.id}">${a.name} (${formatCurrency(getAccountBalance(a.id))})</option>`;
                }
            });
            document.getElementById('pay-card-modal').classList.remove('hidden');
        };
        let payCardId = null;
        window.confirmPayCard = () => {
            if(!payCardId) return;
            const amt = parseFloat(document.getElementById('pay-card-amount').innerText.replace(/[^\d,.-]/g,'').replace('.','').replace(',','.'));
            const src = document.getElementById('pay-card-source').value;
            const dt = new Date().toISOString().split('T')[0];
            
            // Output from Bank
            app.transactions.push({id:'cp-o-'+Date.now(), date:dt, description:'Pagamento Fatura Cartão', amount:amt, type:'despesa', accountId:src, categoryId:SYSTEM_TRANSFER_ID});
            // Input to Card (reduces debt)
            app.transactions.push({id:'cp-i-'+Date.now(), date:dt, description:'Pagamento Fatura', amount:amt, type:'receita', accountId:payCardId, categoryId:SYSTEM_TRANSFER_ID});
            
            saveData(); updateUI(); renderCards(); renderAccs();
            document.getElementById('pay-card-modal').classList.add('hidden');
        };

        function renderTxTable() {
            const l1=document.getElementById('recent-transactions-list'), l2=document.getElementById('all-transactions-list'); l1.innerHTML=''; l2.innerHTML='';
            const start=document.getElementById('tx-filter-start').value, end=document.getElementById('tx-filter-end').value, isDash=!document.getElementById('page-dashboard').classList.contains('hidden');
            let txs=[...app.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date));
            if(!isDash && start && end) txs = txs.filter(t=>new Date(t.date)>=new Date(start)&&new Date(t.date)<=new Date(end));
            if(isDash) txs=txs.slice(0,5);
            txs.forEach(t=>{
                const c=app.categories.find(x=>x.id===t.categoryId)||{name:'?'}, a=app.accounts.find(x=>x.id===t.accountId)||{name:'?'}, isTrf=t.categoryId===SYSTEM_TRANSFER_ID;
                const col=isTrf?'text-blue-400':(t.type==='receita'?'text-green-400':'text-red-400'), pen=t.pending?'border-l-4 border-yellow-500 bg-yellow-900/10':'';
                const h=`<tr class="border-b border-slate-700 hover:bg-slate-800/50 ${pen}"><td class="p-4 text-slate-300 text-xs">${new Date(t.date).toLocaleDateString()}</td><td class="p-4 text-white font-medium flex items-center">${t.pending?'<ion-icon name="time" class="text-yellow-500 mr-1"></ion-icon>':''} ${t.description}</td><td class="p-4 text-xs text-slate-500 uppercase">${isTrf?'TRANSF':t.type}</td><td class="p-4 text-xs text-slate-400">${c.name}</td><td class="p-4 text-xs text-blue-300">${a.name}</td><td class="p-4 text-right font-mono font-bold ${col}">${formatCurrency(t.amount)}</td>${!isDash?`<td class="p-4 text-center flex justify-center gap-2">${t.pending?`<button onclick="confirmTx('${t.id}')" class="text-green-500"><ion-icon name="checkmark-circle" class="text-xl"></ion-icon></button>`:''}<button onclick="delTx('${t.id}')" class="text-slate-600 hover:text-red-500"><ion-icon name="trash" class="text-lg"></ion-icon></button></td>`:''}</tr>`;
                if(isDash) l1.innerHTML+=h; else l2.innerHTML+=h;
            });
        }
        
        function renderDRE(mode='monthly') {
            const mSel=document.getElementById('dre-month'), ySel=document.getElementById('dre-year');
            const now=new Date(); let start, end;
            if(mode==='monthly'){
                const [y,m] = mSel.value.split('-').map(Number);
                start=new Date(y, m-1, 1); end=new Date(y, m, 0);
            } else {
                const y = parseInt(ySel.value);
                start=new Date(y, 0, 1); end=new Date(y, 11, 31);
            }
            // Calc DRE items
            let t = { receita_bruta:0, impostos:0, cpv:0, despesas_op:0, desp_financeiras:0 };
            app.transactions.forEach(x => {
                if(x.categoryId===SYSTEM_TRANSFER_ID || x.pending) return;
                const d=new Date(x.date); if(d<start || d>end) return;
                const c=app.categories.find(k=>k.id===x.categoryId);
                if(c && t[c.dre]!==undefined) t[c.dre]+=x.amount;
            });
            const rl=t.receita_bruta-t.impostos, lb=rl-t.cpv, eb=lb-t.despesas_op, ll=eb-t.desp_financeiras;
            
            const tbl = document.getElementById('dre-table'); tbl.innerHTML='';
            const add=(l,v,b=false)=>{ tbl.innerHTML+=`<tr class="border-b border-slate-700 ${b?'font-bold bg-slate-800/50':''}"><td class="p-3">${l}</td><td class="p-3 text-right ${b?(v>=0?'text-green-400':'text-red-400'):'text-slate-300'}">${formatCurrency(v)}</td></tr>`; };
            add('Receita Bruta', t.receita_bruta); add('(-) Impostos', t.impostos); add('(=) Receita Líquida', rl, true); add('(-) Custo Var.', t.cpv); add('(=) Lucro Bruto', lb, true); add('(-) Desp. Op.', t.despesas_op); add('(=) EBITDA', eb, true); add('(-) Desp. Fin.', t.desp_financeiras); add('(=) Lucro Líquido', ll, true);

            // Waterfall
            const ctx=document.getElementById('dre-waterfall-chart'); if(charts.dre) charts.dre.destroy();
            charts.dre = new Chart(ctx, { type:'bar', data: { labels:['Rec. Bruta','Impostos','CPV','Desp. Op','Lucro Liq'], datasets:[{ data:[t.receita_bruta, -t.impostos, -t.cpv, -t.despesas_op, ll], backgroundColor:['#4ade80','#f87171','#f87171','#f87171','#60a5fa'] }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} });
        }

        function renderBalance() {
            let assets=0, liab=0, invest=0;
            app.accounts.forEach(a=>{ const b=getAccountBalance(a.id); if(a.type==='credit_card') liab+=Math.abs(b); else { assets+=b; if(a.type!=='operational') invest+=b; } });
            document.getElementById('bal-liquidity').innerText = liab>0 ? (assets/liab).toFixed(2) : "∞";
            document.getElementById('balance-equity').innerText = formatCurrency(assets-liab);
            // Allocation Chart
            const ctx=document.getElementById('balance-allocation-chart'); if(charts.alloc) charts.alloc.destroy();
            charts.alloc = new Chart(ctx, { type:'doughnut', data:{ labels:['Caixa','Invest','Dívida'], datasets:[{ data:[assets-invest, invest, liab], backgroundColor:['#60a5fa','#34d399','#f87171'], borderWidth:0 }] }, options:{responsive:true, maintainAspectRatio:false} });
            // Dummy History Chart (Linear)
            const ctx2=document.getElementById('balance-history-chart'); if(charts.hist) charts.hist.destroy();
            charts.hist = new Chart(ctx2, { type:'line', data:{ labels:['M-5','M-4','M-3','M-2','M-1','Atual'], datasets:[{ label:'Patrimônio', data:[assets*0.8, assets*0.85, assets*0.9, assets*0.92, assets*0.95, assets-liab], borderColor:'#3b82f6', tension:0.4 }] }, options:{responsive:true, maintainAspectRatio:false} });
        }
        
        function renderDist() {
            const m = document.getElementById('dist-month').value; if(!m) return;
            const [y,mo] = m.split('-').map(Number);
            let r=0, d=0; app.transactions.forEach(t=>{ if(t.pending||t.categoryId===SYSTEM_TRANSFER_ID) return; const dt=new Date(t.date); if(dt.getFullYear()===y && dt.getMonth()===mo-1){ if(t.type==='receita') r+=t.amount; else d+=t.amount; } });
            const net = Math.max(0, r-d); document.getElementById('dist-net-profit').innerText=formatCurrency(net);
            const tb=document.getElementById('dist-sim-body'); tb.innerHTML=''; let tot=0;
            app.capTable.forEach(ru => { const v=net*(ru.pct/100); tot+=v; tb.innerHTML+=`<tr class="border-b border-slate-700"><td class="p-3 font-bold text-white">${ru.name}</td><td class="p-3"><span class="px-2 py-1 rounded bg-slate-800 text-xs ${ru.type==='partner'?'text-blue-400':'text-purple-400'} uppercase">${ru.type}</span></td><td class="p-3 text-slate-300">${ru.pct}%</td><td class="p-3 text-right font-mono font-bold text-green-400">${formatCurrency(v)}</td></tr>`; });
            document.getElementById('dist-total').innerText=formatCurrency(tot); renderDistRules();
        }
        function renderDistRules() { const l=document.getElementById('dist-rules-list'); l.innerHTML=''; app.capTable.forEach(r=>{ l.innerHTML+=`<li class="flex justify-between bg-slate-700 p-2 rounded text-sm items-center"><span>${r.name} <span class="text-xs text-slate-400">(${r.type})</span></span><div class="flex items-center gap-2"><span class="font-bold text-blue-300">${r.pct}%</span><button onclick="delDistRule(${r.id})" class="text-slate-500 hover:text-red-400"><ion-icon name="trash"></ion-icon></button></div></li>`; }); }
        window.delDistRule = (id) => { app.capTable = app.capTable.filter(r=>r.id!==id); saveData(); renderDist(); };

        function renderProj() {
            if(currentProfile === 'PF') {
                document.getElementById('fire-calc-container').classList.remove('hidden');
                // Calc invested assets ONLY
                let invest = 0;
                app.accounts.forEach(a => { if(a.type === 'goal_pot' || a.type === 'wallet') invest += getAccountBalance(a.id); });
                document.getElementById('fire-current-equity').innerText = formatCurrency(invest);
                const targetInc = parseFloat(document.getElementById('fire-target-income').value)||5000;
                const targetEq = targetInc * 300;
                document.getElementById('fire-target-equity').innerText = "Meta: " + formatCurrency(targetEq);
                document.getElementById('fire-progress').style.width = Math.min(100, (invest/targetEq)*100) + "%";
            } else {
                document.getElementById('fire-calc-container').classList.add('hidden');
            }
            // Projection Chart
            const ctx = document.getElementById('projection-chart'); if(charts.proj) charts.proj.destroy();
            // Simple projected cashflow
            let bal = app.accounts.reduce((s,a)=>s+(a.type!=='credit_card'?getAccountBalance(a.id):-getAccountBalance(a.id)),0);
            const data = [bal];
            app.launchEvents.forEach(e => { bal += (e.rev - e.cost); data.push(bal); });
            charts.proj = new Chart(ctx, { type:'line', data:{ labels:['Hoje', ...app.launchEvents.map(e=>e.name)], datasets:[{ label:'Caixa Projetado', data:data, borderColor:'#10b981', tension:0.4 }] }, options:{responsive:true, maintainAspectRatio:false} });
        }
        function renderLaunchList() { const l=document.getElementById('launch-list'); l.innerHTML=''; app.launchEvents.forEach(e=>{ l.innerHTML+=`<li class="bg-slate-700 p-2 rounded flex justify-between items-center border border-slate-600"><div><span class="font-bold text-white text-sm">${e.name}</span> <span class="text-xs text-slate-400">(${e.date})</span></div><div class="text-right text-xs"><span class="text-red-400">-${formatCurrency(e.cost)}</span> / <span class="text-green-400">+${formatCurrency(e.rev)}</span> <button onclick="delLaunch('${e.id}')" class="ml-2 text-slate-400 hover:text-red-500"><ion-icon name="trash"></ion-icon></button></div></li>`; }); }
        window.delLaunch = (id) => { app.launchEvents = app.launchEvents.filter(e=>e.id!==id); saveData(); renderProj(); };
        
        // STACK
        window.renderStack = () => {
            const l = document.getElementById('stack-list'); if(!l) return; l.innerHTML = ''; let total = 0; let baseTotal = 0;
            const simRate = parseFloat(document.getElementById('usd-simulator').value);
            
            app.stack.forEach(t => { 
                const rate = t.currency === 'USD' ? simRate : 1;
                const cost = t.price * rate; 
                total += cost;
                
                l.innerHTML += `<div class="flex justify-between items-center bg-slate-700 p-3 rounded border border-slate-600"> 
                    <div><p class="font-bold text-white">${t.name}</p><p class="text-xs text-slate-400">${t.currency} ${t.price.toFixed(2)}</p></div> 
                    <div class="flex items-center gap-3"><p class="font-mono text-green-400">${formatCurrency(cost)}</p><button onclick="delTool('${t.id}')" class="text-red-400"><ion-icon name="trash"></ion-icon></button></div> 
                </div>`; 
            }); 
            document.getElementById('stack-total').innerText = formatCurrency(total);
            
            // Calc base total for impact
            app.stack.forEach(t => { baseTotal += (t.currency==='USD'?t.price * 5.80 : t.price); }); // Assuming 5.80 base
            const diff = total - baseTotal;
            document.getElementById('stack-impact-msg').innerText = `Impacto: ${diff>0?'+':''}${formatCurrency(diff)}`;
            document.getElementById('simulated-rate-display').innerText = `Dólar: R$ ${simRate.toFixed(2)}`;
        }
        document.getElementById('usd-simulator').addEventListener('input', renderStack);
        document.getElementById('form-add-tool').addEventListener('submit', (e)=>{ e.preventDefault(); app.stack.push({id:Date.now(), name:document.getElementById('tool-name').value, price:parseFloat(document.getElementById('tool-price').value), currency:document.getElementById('tool-currency').value}); saveData(); renderStack(); document.getElementById('form-add-tool').reset(); });
        window.delTool = (id) => { app.stack=app.stack.filter(s=>s.id!==id); saveData(); renderStack(); };
        document.getElementById('tool-currency').addEventListener('change', (e) => { document.getElementById('usd-rate-field').classList.toggle('hidden', e.target.value!=='USD'); });

        // Support Functions
        window.delTx = (id) => { app.transactions=app.transactions.filter(t=>t.id!==id); saveData(); updateUI(); };
        window.confirmTx = (id) => { const t=app.transactions.find(x=>x.id===id); if(t){ t.pending=false; saveData(); updateUI(); } };
        window.closeModal = () => document.getElementById('transaction-modal').classList.add('hidden');
        window.openTaxOptions = () => { if(currentProfile!=='PJ') return; const prov=document.getElementById('dashboard-tax-provision').innerText.replace(/[^\d,.-]/g,'').replace('.','').replace(',','.'); document.getElementById('tax-suggested-val').innerText=formatCurrency(parseFloat(prov)); document.getElementById('tax-action-val').value=parseFloat(prov).toFixed(2); const p=document.getElementById('tax-pay-acc'), r=document.getElementById('tax-res-acc'); p.innerHTML=''; r.innerHTML=''; app.accounts.forEach(a=>{ if(a.type!=='goal_pot') p.innerHTML+=`<option value="${a.id}">${a.name}</option>`; if(a.type==='goal_pot') r.innerHTML+=`<option value="${a.id}">${a.name}</option>`; }); document.getElementById('tax-options-modal').classList.remove('hidden'); };
        window.openWarChestOptions = () => { const prov=document.getElementById('dashboard-war-chest').innerText.replace(/[^\d,.-]/g,'').replace('.','').replace(',','.'); document.getElementById('war-suggested-val').innerText=formatCurrency(parseFloat(prov)); document.getElementById('war-action-val').value=parseFloat(prov).toFixed(2); const s=document.getElementById('war-source'), d=document.getElementById('war-dest'); s.innerHTML=''; d.innerHTML=''; app.accounts.forEach(a=>{ if(a.type!=='goal_pot') s.innerHTML+=`<option value="${a.id}">${a.name}</option>`; if(a.type==='goal_pot') d.innerHTML+=`<option value="${a.id}">${a.name}</option>`; }); document.getElementById('war-chest-modal').classList.remove('hidden'); };
        window.openTaxAction = (t) => { const v=parseFloat(document.getElementById('tax-action-val').value), d=new Date().toISOString().split('T')[0]; if(t==='pay') app.transactions.push({id:'tx-p-'+Date.now(),date:d,description:'Pgto Imposto [IMPOSTO]',amount:v,type:'despesa',accountId:document.getElementById('tax-pay-acc').value,categoryId:app.categories.find(c=>c.dre==='impostos')?.id}); else { const src=app.accounts.find(a=>a.type==='operational')?.id; if(!src) return alert('Sem conta'); app.transactions.push({id:'tx-o-'+Date.now(),date:d,description:'Reserva Imposto [IMPOSTO]',amount:v,type:'despesa',accountId:src,categoryId:SYSTEM_TRANSFER_ID}); app.transactions.push({id:'tx-i-'+Date.now(),date:d,description:'Reserva Imposto [IMPOSTO]',amount:v,type:'receita',accountId:document.getElementById('tax-res-acc').value,categoryId:SYSTEM_TRANSFER_ID}); } saveData(); updateUI(); document.getElementById('tax-options-modal').classList.add('hidden'); };
        window.confirmWarChest = () => { const v=parseFloat(document.getElementById('war-action-val').value), s=document.getElementById('war-source').value, d=document.getElementById('war-dest').value, dt=new Date().toISOString().split('T')[0]; if(!s||!d) return; app.transactions.push({id:'wc-o-'+Date.now(),date:dt,description:'Aporte Cofre [COFRE]',amount:v,type:'despesa',accountId:s,categoryId:SYSTEM_TRANSFER_ID}); app.transactions.push({id:'wc-i-'+Date.now(),date:dt,description:'Aporte Cofre [COFRE]',amount:v,type:'receita',accountId:d,categoryId:SYSTEM_TRANSFER_ID}); saveData(); updateUI(); document.getElementById('war-chest-modal').classList.add('hidden'); };
        window.toggleTxFields = () => { const t=document.querySelector('input[name="tx-type"]:checked').value; document.getElementById('standard-fields').classList.toggle('hidden', t==='transfer'); document.getElementById('transfer-fields').classList.toggle('hidden', t!=='transfer'); };
        window.toggleCardFields = () => { const t=document.getElementById('account-type').value; document.getElementById('card-fields').classList.toggle('hidden', t!=='credit_card'); };
        window.renderGoals = () => { const l=document.getElementById('goals-list'); l.innerHTML=''; app.goals.forEach(g=>{ const a=app.accounts.find(x=>x.id===g.accountId), cur=a?getAccountBalance(a.id):0, pct=Math.min(100,(cur/g.value)*100).toFixed(1); l.innerHTML+=`<div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-md"><div class="flex justify-between mb-3"><span class="font-bold text-lg text-white">${g.name}</span><button onclick="delGoal('${g.id}')" class="text-slate-600 hover:text-red-500"><ion-icon name="trash"></ion-icon></button></div><div class="w-full bg-slate-900 rounded-full h-3 mb-2"><div class="bg-blue-500 h-3 rounded-full" style="width:${pct}%"></div></div><div class="flex justify-between text-xs font-mono text-slate-400"><span>${formatCurrency(cur)}</span><span>Meta: ${formatCurrency(g.value)}</span></div></div>`; }); };
        window.delGoal = (id) => { app.goals=app.goals.filter(g=>g.id!==id); saveData(); renderGoals(); };
        window.renderRec = () => { const l=document.getElementById('recurring-list'); l.innerHTML=''; app.recurring.forEach(r=>{ l.innerHTML+=`<div class="bg-slate-700 p-3 rounded flex justify-between items-center border border-slate-600"><div><div class="font-bold text-white">${r.description}</div><div class="text-xs text-slate-400">Dia ${r.day} • ${r.type.toUpperCase()}</div></div><div class="text-right"><div class="font-mono ${r.type==='receita'?'text-green-400':'text-red-400'}">${formatCurrency(r.amount)}</div><button onclick="delRec(${r.id})" class="text-xs text-red-500">Excluir</button></div></div>`; }); };
        window.delRec = (id) => { app.recurring=app.recurring.filter(r=>r.id!==id); saveData(); renderRec(); };
        window.renderChecklist = () => { const l=document.getElementById('checklist-container'), p=document.getElementById('checklist-progress'); l.innerHTML=''; let d=0; app.checklist.forEach(t=>{ if(t.done) d++; l.innerHTML+=`<li class="checklist-item flex items-center gap-3 p-2 bg-slate-700 rounded ${t.done?'checked':''}"><button onclick="toggleCheck(${t.id})" class="text-xl ${t.done?'text-green-500':'text-slate-500'}"><ion-icon name="${t.done?'checkbox':'square-outline'}"></ion-icon></button><span class="flex-1 text-sm text-slate-200">${t.text}</span><button onclick="delCheck(${t.id})" class="text-slate-600 hover:text-red-500"><ion-icon name="trash"></ion-icon></button></li>`; }); p.style.width = app.checklist.length ? (d/app.checklist.length)*100+"%" : "0%"; };
        window.toggleCheck = (id) => { const t=app.checklist.find(x=>x.id===id); if(t){ t.done=!t.done; saveData(); renderChecklist(); } };
        window.delCheck = (id) => { app.checklist=app.checklist.filter(x=>x.id!==id); saveData(); renderChecklist(); };
        window.renderAuto = () => { const l=document.getElementById('tags-list'), r=document.getElementById('rules-list'); l.innerHTML=''; r.innerHTML=''; app.tags.forEach(t=>l.innerHTML+=`<li class="bg-slate-700 p-2 rounded inline-block mr-2 mb-2 text-xs">#${t}</li>`); app.rules.forEach((ru,i)=>r.innerHTML+=`<li class="bg-slate-700 p-2 rounded text-xs flex justify-between"><span>"${ru.term}" -> ${app.categories.find(c=>c.id===ru.cat)?.name||'?'}</span><button onclick="delRule(${i})" class="text-red-400">X</button></li>`);
             const panel=document.getElementById('auto-config-panel');
             if(currentProfile==='PJ'){ panel.innerHTML=`<h3 class="text-lg font-bold mb-4 text-white">Config PJ</h3><div class="mb-4"><label class="block text-sm text-slate-400">Taxa Imposto (%)</label><input type="number" id="cfg-tax" class="bg-slate-700 border border-slate-600 rounded p-2 w-20" value="${app.taxRate}" onchange="saveCfg()"></div><div><label class="block text-sm text-slate-400">Reserva Cofre (%)</label><input type="number" id="cfg-war" class="bg-slate-700 border border-slate-600 rounded p-2 w-20" value="${app.warRate}" onchange="saveCfg()"></div>`; }
             else { panel.innerHTML=`<h3 class="text-lg font-bold mb-4 text-white">Regra 50/30/20</h3><p class="text-sm text-slate-400">No perfil pessoal, a classificação é automática baseada na sub-categoria escolhida (Essencial, Estilo, Objetivos) na aba 'Categorias'.</p>`; }
        };
        window.delRule = (i) => { app.rules.splice(i,1); saveData(); renderAuto(); };
        window.saveCfg = () => { if(currentProfile==='PJ'){ app.taxRate=parseFloat(document.getElementById('cfg-tax').value); app.warRate=parseFloat(document.getElementById('cfg-war').value); saveData(); updateUI(); } };
        window.showHoldingReport = () => { const pjBal=DB.PJ.accounts.reduce((s,a)=>s+(a.type!=='credit_card'?getAccountBalance(a.id):0),0); const pfBal=DB.PF.accounts.reduce((s,a)=>s+(a.type!=='credit_card'?getAccountBalance(a.id):0),0); const debt=Math.abs(DB.PJ.accounts.reduce((s,a)=>s+(a.type==='credit_card'?getAccountBalance(a.id):0),0)) + Math.abs(DB.PF.accounts.reduce((s,a)=>s+(a.type==='credit_card'?getAccountBalance(a.id):0),0)); document.getElementById('hold-pj').innerText=formatCurrency(pjBal); document.getElementById('hold-pf').innerText=formatCurrency(pfBal); document.getElementById('hold-debt').innerText=formatCurrency(debt); document.getElementById('hold-total').innerText=formatCurrency(pjBal+pfBal-debt); document.getElementById('holding-modal').classList.remove('hidden'); };
        window.confirmClear = () => { localStorage.removeItem('financeHub_FULL_v14_3'); seedData(); document.getElementById('confirm-modal').classList.add('hidden'); };
        window.renderCats = () => { 
            const rl=document.getElementById('receita-categories-list'), dl=document.getElementById('despesa-categories-list'); 
            rl.innerHTML=''; dl.innerHTML=''; 
            app.categories.forEach(c=>{ if(c.id===SYSTEM_TRANSFER_ID) return; const h=`<li class="flex justify-between bg-slate-900/50 p-2 rounded border border-slate-700"><span>${c.name}</span> <span class="text-xs text-slate-500">${c.dre||c.sub||'-'}</span></li>`; if(c.type==='receita') rl.innerHTML+=h; else dl.innerHTML+=h; }); 
            const dreSel=document.getElementById('category-dre-account'); dreSel.innerHTML=''; 
            if(currentProfile==='PJ'){ 
                const opts={receita_bruta:'Receita Bruta', impostos:'Impostos', cpv:'CPV', despesas_op:'Despesas Op', desp_financeiras:'Desp Fin'}; 
                for(let k in opts) dreSel.innerHTML+=`<option value="${k}">${opts[k]}</option>`; 
            } else { 
                const opts={renda:'Renda', essencial:'Essencial (50)', estilo:'Estilo (30)', objetivos:'Objetivos (20)'}; 
                for(let k in opts) dreSel.innerHTML+=`<option value="${k}">${opts[k]}</option>`; 
            }
            const typSel=document.getElementById('category-type'); typSel.innerHTML='<option value="despesa">Despesa</option><option value="receita">Receita</option>';
        };
        document.getElementById('form-add-category').addEventListener('submit', (e)=>{ e.preventDefault(); app.categories.push({id:'cat-'+Date.now(), name:document.getElementById('category-name').value, type:document.getElementById('category-type').value, dre:currentProfile==='PJ'?document.getElementById('category-dre-account').value:null, sub:currentProfile==='PF'?document.getElementById('category-dre-account').value:null}); saveData(); renderCats(); document.getElementById('form-add-category').reset(); });

        window.handleFileSelect = (input) => { const f=input.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ processImport(e.target.result, f.name.endsWith('.ofx')); input.value=''; }; r.readAsText(f); };
        window.processImport = (txt, isOfx) => {
            const list=document.getElementById('import-list'); list.innerHTML=''; window.pendingImport=[];
            const lines=txt.split('\n');
            if(isOfx) {
                const amts=txt.match(/<TRNAMT>([-0-9.]+)/g); const descs=txt.match(/<MEMO>(.+)/g);
                if(amts){ amts.forEach((a,i)=>{ const v=parseFloat(a.replace('<TRNAMT>','')); const d=descs[i]?descs[i].replace('<MEMO>','').trim():'Importado'; window.pendingImport.push({date:new Date().toISOString().slice(0,10), desc:d, amount:Math.abs(v), type:v<0?'despesa':'receita'}); }); }
            } else {
                lines.forEach(l=>{ const c=l.split(','); if(c.length>=3){ const v=parseFloat(c[2]); if(!isNaN(v)) window.pendingImport.push({date:c[0], desc:c[1], amount:Math.abs(v), type:v<0?'despesa':'receita'}); } });
            }
            window.pendingImport.forEach(i => list.innerHTML+=`<tr><td>${i.desc}</td><td>${i.amount}</td></tr>`);
            document.getElementById('import-preview').classList.remove('hidden');
        };
        document.getElementById('btn-confirm-import').onclick = () => { if(window.pendingImport){ window.pendingImport.forEach(i=>{ app.transactions.push({id:'imp-'+Date.now()+Math.random(), date:i.date, description:i.desc, amount:i.amount, type:i.type, accountId:app.accounts[0]?.id, categoryId:app.categories[0]?.id}); }); saveData(); updateUI(); document.getElementById('import-preview').classList.add('hidden'); } };
        document.getElementById('btn-export').onclick = () => { const blob=new Blob([JSON.stringify(DB)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`finance_hub_FULL_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); };
        document.getElementById('file-backup-input').onchange = (e) => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ DB=JSON.parse(ev.target.result); app=DB[currentProfile]; saveData(); location.reload(); }; r.readAsText(f); };

        // Events
        document.getElementById('form-add-dist-rule').addEventListener('submit', (e) => {
             e.preventDefault();
             app.capTable.push({id:Date.now(), name:document.getElementById('dist-name').value, pct:parseFloat(document.getElementById('dist-pct').value), type:document.getElementById('dist-type').value});
             saveData(); renderDist(); document.getElementById('form-add-dist-rule').reset();
        });

        document.getElementById('form-add-transaction').addEventListener('submit', (e) => {
            e.preventDefault();
            const t = document.querySelector('input[name="tx-type"]:checked').value;
            const desc = document.getElementById('tx-desc').value, amt=parseFloat(document.getElementById('tx-amount').value), dt=document.getElementById('tx-date').value;
            const isPending = document.getElementById('tx-pending').checked;
            
            if(t === 'transfer') {
                const s=document.getElementById('tx-source').value, d=document.getElementById('tx-dest').value;
                app.transactions.push({id:'tr-o-'+Date.now(),date:dt,description:'TRF Enviada: '+desc,amount:amt,type:'despesa',categoryId:SYSTEM_TRANSFER_ID,accountId:s,pending:isPending});
                app.transactions.push({id:'tr-i-'+Date.now(),date:dt,description:'TRF Recebida: '+desc,amount:amt,type:'receita',categoryId:SYSTEM_TRANSFER_ID,accountId:d,pending:isPending});
            } else {
                const cat=document.getElementById('tx-category').value, acc=document.getElementById('tx-account').value;
                app.transactions.push({id:'tx-'+Date.now(),date:dt,description:desc,amount:amt,type:t,categoryId:cat,accountId:acc,pending:isPending});
                
                // Cross-profile logic
                if(currentProfile==='PJ' && document.getElementById('tx-reimburse-link').checked && t==='despesa'){
                     // Add pending reimbursement to PF if exists
                     if(DB.PF) DB.PF.transactions.push({id:'rem-'+Date.now(), date:dt, description:'Reembolso Pendente PJ', amount:amt, type:'receita', categoryId:SYSTEM_TRANSFER_ID, accountId:DB.PF.accounts[0]?.id, pending:true});
                }
                if(currentProfile==='PF' && document.getElementById('tx-salary-link').checked && t==='receita'){
                     // No op for now, logic is manual
                }
            }
            saveData(); updateUI(); closeModal(); document.getElementById('form-add-transaction').reset();
        });

        document.getElementById('form-save-account').addEventListener('submit', (e) => {
            e.preventDefault();
            const id=document.getElementById('account-id').value;
            const dat={ name:document.getElementById('account-name').value, type:document.getElementById('account-type').value, initialBalance:parseFloat(document.getElementById('account-initial-balance').value), limit:parseFloat(document.getElementById('card-limit').value)||0, closingDay:document.getElementById('card-closing').value, dueDay:document.getElementById('card-due').value };
            if(id){ const i=app.accounts.findIndex(a=>a.id===id); if(i>=0) app.accounts[i]={...app.accounts[i],...dat}; }
            else { app.accounts.push({id:'acc-'+Date.now(),...dat}); }
            saveData(); updateUI(); renderAccs(); renderCards(); document.getElementById('form-save-account').reset();
        });
        
        // Budget Logic
        window.renderBudget = () => { const l=document.getElementById('budget-list'); l.innerHTML=''; app.budgets.forEach(b => { const c=app.categories.find(x=>x.id===b.categoryId); const spent=app.transactions.filter(t=>t.type==='despesa' && t.categoryId===b.categoryId && t.date.startsWith(b.month) && !t.pending).reduce((s,t)=>s+t.amount,0); const pct=Math.min(100, (spent/b.amount)*100); const col = pct>90?'bg-red-500':(pct>70?'bg-yellow-500':'bg-green-500'); l.innerHTML+=`<div class="bg-slate-700 p-3 rounded"> <div class="flex justify-between text-sm mb-1 text-white"><span>${c?c.name:'?'}</span><span>${formatCurrency(spent)} / ${formatCurrency(b.amount)}</span></div> <div class="w-full bg-slate-900 rounded-full h-2"><div class="${col} h-2 rounded-full" style="width:${pct}%"></div></div> </div>`; }); };
        document.getElementById('form-budget').addEventListener('submit', (e)=>{ e.preventDefault(); const m=document.getElementById('budget-month-input').value, c=document.getElementById('budget-category').value, v=parseFloat(document.getElementById('budget-limit').value); app.budgets=app.budgets.filter(b=>!(b.month===m && b.categoryId===c)); app.budgets.push({id:Date.now(),month:m,categoryId:c,amount:v}); saveData(); renderBudget(); });
        window.cloneBudget = () => { const cur=document.getElementById('budget-month-input').value; if(!cur) return; const [y,m]=cur.split('-').map(Number); const prevD=new Date(y,m-2,1); const prevM=prevD.toISOString().slice(0,7); const prevs=app.budgets.filter(b=>b.month===prevM); prevs.forEach(b=>{ if(!app.budgets.find(x=>x.month===cur && x.categoryId===b.categoryId)) app.budgets.push({...b, id:Date.now()+Math.random(), month:cur}); }); saveData(); renderBudget(); };
        window.calculateScale = () => { const d=parseFloat(document.getElementById('scale-daily-spend').value), r=parseInt(document.getElementById('scale-receipt-days').value), c=parseInt(document.getElementById('scale-card-days').value); const gap = r - c; const val = gap > 0 ? d * gap : 0; document.getElementById('scale-capital-needed').innerText = formatCurrency(val); document.getElementById('scale-result').classList.remove('hidden'); };

        // Initialize
        window.onload = function() {
            initDB();
            // Populate dates
            const now = new Date();
            const y = now.getFullYear();
            const mSel = document.getElementById('dre-month');
            const ySel = document.getElementById('dre-year');
            for(let i=0; i<12; i++) { const d=new Date(y, i, 1); mSel.innerHTML+=`<option value="${y}-${String(i+1).padStart(2,'0')}">${d.toLocaleString('default',{month:'long'})} ${y}</option>`; }
            for(let i=0; i<10; i++) ySel.innerHTML+=`<option value="${y+i}">${y+i}</option>`;
            
            // Render Listeners
            document.getElementById('btn-reset-check').onclick = () => { app.checklist.forEach(t=>t.done=false); saveData(); renderChecklist(); };
            document.getElementById('form-add-task').onsubmit = (e) => { e.preventDefault(); app.checklist.push({id:Date.now(),text:document.getElementById('task-desc').value,done:false}); saveData(); renderChecklist(); document.getElementById('task-desc').value=''; };
            document.getElementById('form-add-launch').onsubmit = (e) => { e.preventDefault(); app.launchEvents.push({id:Date.now(),name:document.getElementById('launch-name').value,date:document.getElementById('launch-date').value,rev:parseFloat(document.getElementById('launch-val').value),cost:0}); saveData(); renderProj(); renderLaunchList(); document.getElementById('form-add-launch').reset(); };
            document.getElementById('form-add-goal').onsubmit = (e) => { e.preventDefault(); app.goals.push({id:Date.now(),name:document.getElementById('goal-name').value,value:parseFloat(document.getElementById('goal-value').value),accountId:document.getElementById('goal-account-id').value}); saveData(); renderGoals(); document.getElementById('form-add-goal').reset(); };
            
            // Popups
            const popTx = () => { 
                const c=document.getElementById('tx-category'), a=document.getElementById('tx-account'), s=document.getElementById('tx-source'), d=document.getElementById('tx-dest'); 
                c.innerHTML=''; [a,s,d].forEach(e=>e.innerHTML=''); 
                app.categories.forEach(cat=>{ if(cat.id!==SYSTEM_TRANSFER_ID) c.innerHTML+=`<option value="${cat.id}">${cat.name}</option>`; }); 
                app.accounts.forEach(acc=>{ const o=`<option value="${acc.id}">${acc.name} (${formatCurrency(getAccountBalance(acc.id))})</option>`; a.innerHTML+=o; s.innerHTML+=o; d.innerHTML+=o; });
                document.getElementById('transaction-modal').classList.remove('hidden'); document.getElementById('transaction-modal').classList.add('flex');
            };
            document.getElementById('open-modal-btn').onclick = popTx;
            
            // Filters
            const updateFilterUI = () => { ['btn-filter-thisMonth','btn-filter-lastMonth','btn-filter-all'].forEach(id=>document.getElementById(id).classList.remove('bg-slate-600','text-white')); };
            document.getElementById('btn-filter-thisMonth').onclick = () => { updateFilterUI(); document.getElementById('btn-filter-thisMonth').classList.add('bg-slate-600','text-white'); document.getElementById('dash-filter-start').value=''; document.getElementById('dash-filter-end').value=''; updateUI(); };
            document.getElementById('btn-filter-lastMonth').onclick = () => { updateFilterUI(); document.getElementById('btn-filter-lastMonth').classList.add('bg-slate-600','text-white'); const d=new Date(); const s=new Date(d.getFullYear(), d.getMonth()-1, 1); const e=new Date(d.getFullYear(), d.getMonth(), 0); document.getElementById('dash-filter-start').value=s.toISOString().slice(0,10); document.getElementById('dash-filter-end').value=e.toISOString().slice(0,10); updateUI(); };
            document.getElementById('btn-filter-all').onclick = () => { updateFilterUI(); document.getElementById('btn-filter-all').classList.add('bg-slate-600','text-white'); document.getElementById('dash-filter-start').value='2000-01-01'; document.getElementById('dash-filter-end').value='2099-12-31'; updateUI(); };
            document.getElementById('btn-close-notif').onclick = () => document.getElementById('notification-center').classList.add('hidden');
            
            updateNav(); updateUI();
        };

        window.popRecOptions = () => { const c=document.getElementById('rec-category'), a=document.getElementById('rec-account'); c.innerHTML=''; a.innerHTML=''; app.categories.forEach(cat=>c.innerHTML+=`<option value="${cat.id}">${cat.name}</option>`); app.accounts.forEach(acc=>a.innerHTML+=`<option value="${acc.id}">${acc.name}</option>`); };
        document.getElementById('form-recurring').addEventListener('submit', (e)=>{ e.preventDefault(); app.recurring.push({id:Date.now(),description:document.getElementById('rec-desc').value,day:parseInt(document.getElementById('rec-day').value),amount:parseFloat(document.getElementById('rec-amount').value),type:document.getElementById('rec-type').value,categoryId:document.getElementById('rec-category').value,accountId:document.getElementById('rec-account').value}); saveData(); renderRec(); document.getElementById('form-recurring').reset(); });
        window.cancelEditAccount = () => { document.getElementById('form-save-account').reset(); document.getElementById('account-id').value=''; };
        window.renderCharts = () => {
             // Expense Chart
             const ctx=document.getElementById('expense-chart'); if(charts.exp) charts.exp.destroy();
             const cats={}; app.transactions.forEach(t=>{ if(t.type==='despesa' && !t.pending){ const n=app.categories.find(c=>c.id===t.categoryId)?.name||'?'; cats[n]=(cats[n]||0)+t.amount; } });
             charts.exp = new Chart(ctx, { type:'bar', data:{ labels:Object.keys(cats), datasets:[{ label:'Despesas', data:Object.values(cats), backgroundColor:'#f87171' }] }, options:{responsive:true, maintainAspectRatio:false} });
             // Pareto
             const ctx2=document.getElementById('pareto-chart'); if(charts.par) charts.par.destroy();
             const sorted = Object.entries(cats).sort((a,b)=>b[1]-a[1]);
             let acc=0; const total=sorted.reduce((s,i)=>s+i[1],0); const paretoData=sorted.map(i=>{ acc+=i[1]; return (acc/total)*100; });
             charts.par = new Chart(ctx2, { type:'line', data:{ labels:sorted.map(i=>i[0]), datasets:[{ label:'Acumulado %', data:paretoData, borderColor:'#fbbf24', yAxisID:'y1' }, { label:'Valor', data:sorted.map(i=>i[1]), type:'bar', backgroundColor:'#60a5fa', yAxisID:'y' }] }, options:{responsive:true, maintainAspectRatio:false} });
             // Break Even
             const fixed = app.recurring.filter(x => x.type === 'despesa').reduce((s,i) => s+i.amount, 0);
             const variable = app.transactions.filter(t=>t.type==='despesa' && !t.pending).reduce((s,t)=>s+t.amount,0) - fixed;
             const rev = app.transactions.filter(t=>t.type==='receita' && !t.pending).reduce((s,t)=>s+t.amount,0);
             const margin = rev > 0 ? (rev-variable)/rev : 0;
             const be = margin > 0 ? fixed / margin : 0;
             document.getElementById('break-even-val').innerText = formatCurrency(be);
        };
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>